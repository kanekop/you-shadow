<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>éŸ³èª­ç²¾åº¦ãƒã‚§ãƒƒã‚¯</title>
  <script defer>
    let recorder;
    let chunks = [];
    let referenceText = "";

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("startBtn").addEventListener("click", startRecording);
      document.getElementById("stopBtn").addEventListener("click", stopRecording);
      document.getElementById("submitBtn").addEventListener("click", submitRecording);
      document.getElementById("loadTextBtn").addEventListener("click", loadText);
    });

    function loadText() {
      referenceText = document.getElementById("referenceInput").value.trim();
      if (!referenceText) {
        alert("æ­£è§£ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      document.getElementById("displayText").innerText = referenceText;
      document.getElementById("textLoaded").style.display = "block";
    }

    function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          recorder = new MediaRecorder(stream);
          chunks = [];
          recorder.ondataavailable = e => chunks.push(e.data);
          recorder.onstop = handleStop;
          recorder.start();

          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;
        })
        .catch(err => {
          alert("ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          console.error(err);
        });
    }

    function stopRecording() {
      if (recorder && recorder.state === "recording") {
        recorder.stop();
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        document.getElementById("submitBtn").disabled = false;
      }
    }

    function handleStop() {
      const audioBlob = new Blob(chunks, { type: 'audio/webm' });
      document.getElementById("recordedAudio").src = URL.createObjectURL(audioBlob);
      document.recordedBlob = audioBlob;
    }

    function submitRecording() {
      if (!referenceText || !document.recordedBlob) {
        alert("æ­£è§£ãƒ†ã‚­ã‚¹ãƒˆã¨éŒ²éŸ³éŸ³å£°ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™ã€‚");
        return;
      }

      const formData = new FormData();
      formData.append("audio", document.recordedBlob);
      formData.append("transcript", referenceText);

      fetch("/evaluate_read_aloud", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          document.getElementById("resultBox").innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + data.error;
        } else {
          document.getElementById("resultBox").innerHTML = `
            âœ… WER: ${data.wer}%<br>
            <hr>
            ğŸ” Diff:<br>${data.diff_html}<br>
            <hr>
            ğŸ“œ Original Text:<br>${referenceText}<br>
            <hr>
            ğŸ—£ï¸ Your Transcription:<br>${data.transcribed}
          `;
        }
      })
      .catch(err => {
        console.error("è©•ä¾¡ã‚¨ãƒ©ãƒ¼:", err);
        document.getElementById("resultBox").innerText = "âŒ æå‡ºã‚¨ãƒ©ãƒ¼";
      });
    }
  </script>
</head>
<body>
  <h2>ğŸ“˜ éŸ³èª­ã®ç²¾åº¦ãƒã‚§ãƒƒã‚¯</h2>

  <textarea id="referenceInput" rows="8" cols="80" placeholder="ã“ã“ã«éŸ³èª­ç”¨ã®æ­£è§£ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea><br>
  <button id="loadTextBtn">ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€</button>

  <div id="textLoaded" style="display: none; margin-top: 1em;">
    <h3>éŸ³èª­ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆï¼š</h3>
    <p id="displayText" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 1em;"></p>

    <button id="startBtn">â–¶ï¸ éŒ²éŸ³é–‹å§‹</button>
    <button id="stopBtn" disabled>â¹ åœæ­¢</button>
    <button id="submitBtn" disabled>ğŸ“ æå‡ºã—ã¦è©•ä¾¡</button>

    <audio id="recordedAudio" controls style="margin-top: 1em;"></audio>

    <div id="resultBox" style="margin-top: 2em;"></div>
  </div>
</body>
</html>
