<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚·ãƒ£ãƒ‰ã‚¦ã‚¤ãƒ³ã‚°ç²¾åº¦ãƒã‚§ãƒƒã‚¯</title>
  <script defer>
    let recorder;
    let chunks = [];
    let originalAudioBlob = null;

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("audioFileInput").addEventListener("change", handleAudioLoad);
      document.getElementById("startBtn").addEventListener("click", startRecording);
      document.getElementById("stopBtn").addEventListener("click", stopRecording);
      document.getElementById("submitBtn").addEventListener("click", submitRecording);
    });

    function handleAudioLoad(event) {
      const file = event.target.files[0];
      if (!file) return;

      originalAudioBlob = file;
      const audioUrl = URL.createObjectURL(file);
      document.getElementById("originalAudio").src = audioUrl;
      document.getElementById("audioLoadedBox").style.display = "block";
    }

    function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          recorder = new MediaRecorder(stream);
          chunks = [];
          recorder.ondataavailable = e => chunks.push(e.data);
          recorder.onstop = handleStop;
          recorder.start();

          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;

          // åŒæ™‚å†ç”Ÿ
          document.getElementById("originalAudio").currentTime = 0;
          document.getElementById("originalAudio").play();
        })
        .catch(err => {
          alert("ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          console.error(err);
        });
    }

    function stopRecording() {
      if (recorder && recorder.state === "recording") {
        recorder.stop();
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        document.getElementById("submitBtn").disabled = false;
      }
    }

    function handleStop() {
      const recordedBlob = new Blob(chunks, { type: 'audio/webm' });
      document.getElementById("recordedAudio").src = URL.createObjectURL(recordedBlob);
      document.recordedBlob = recordedBlob;
    }

    function submitRecording() {
      if (!originalAudioBlob || !document.recordedBlob) {
        alert("å…ƒéŸ³å£°ã¨éŒ²éŸ³éŸ³å£°ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™ã€‚");
        return;
      }

      const formData = new FormData();
      formData.append("original_audio", originalAudioBlob);
      formData.append("recorded_audio", document.recordedBlob);

      fetch("/evaluate_shadowing", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          document.getElementById("resultBox").innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + data.error;
        } else {
          document.getElementById("resultBox").innerHTML = `
            <div class="result-box">
              <h3 class="success">âœ… WER: ${data.wer}%</h3>
              <hr>
              <div class="diff-section">
                <h4>ğŸ” Diff:</h4>
                ${data.diff_html}
              </div>
              <hr>
              <div class="text-section">
                <h4>ğŸ“œ Original Transcription:</h4>
                <div class="display-text">${data.original_transcribed}</div>
              </div>
              <hr>
              <div class="text-section">
                <h4>ğŸ—£ï¸ Your Transcription:</h4>
                <div class="display-text">${data.user_transcribed}</div>
              </div>
            </div>
          `;
        }
      })
      .catch(err => {
        console.error("æå‡ºæ™‚ã‚¨ãƒ©ãƒ¼:", err);
        document.getElementById("resultBox").innerText = "âŒ æå‡ºå¤±æ•—";
      });
    }
  </script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
      <h1>ğŸ§ ã‚·ãƒ£ãƒ‰ã‚¦ã‚¤ãƒ³ã‚°ç²¾åº¦ãƒã‚§ãƒƒã‚¯</h1>
      <div class="nav-links">
        <a href="/">ãƒ›ãƒ¼ãƒ </a>
        <a href="/read-aloud">éŸ³èª­</a>
        <a href="/shadowing">ã‚·ãƒ£ãƒ‰ã‚¦ã‚¤ãƒ³ã‚°</a>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="card">
      <h3>1. å…ƒã®éŸ³å£°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
      <input type="file" id="audioFileInput" accept="audio/*">
    </div>

    <div id="audioLoadedBox" style="display:none">
      <div class="card">
        <h3>2. ã‚·ãƒ£ãƒ‰ã‚¦ã‚¤ãƒ³ã‚°éŒ²éŸ³</h3>
        <p>ğŸ”Š å†ç”Ÿã—ãªãŒã‚‰éŒ²éŸ³ã—ã¦ãã ã•ã„ï¼š</p>
        <audio id="originalAudio" controls></audio>
        
        <div class="button-group">
          <button id="startBtn">â–¶ï¸ éŒ²éŸ³é–‹å§‹</button>
          <button id="stopBtn" disabled>â¹ åœæ­¢</button>
          <button id="submitBtn" disabled>ğŸ“ æå‡ºã—ã¦è©•ä¾¡</button>
        </div>

        <h4>éŒ²éŸ³éŸ³å£°ï¼š</h4>
        <audio id="recordedAudio" controls></audio>
      </div>

      <div class="card">
        <h3>3. è©•ä¾¡çµæœ</h3>
        <div id="resultBox"></div>
      </div>
    </div>
  </div>
</body>
</html>
